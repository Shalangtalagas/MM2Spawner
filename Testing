local TweenService = game:GetService("TweenService")
local itemdatabase = require(game:GetService("ReplicatedStorage").Database.Sync.Item)

-- Function to get item image
local function getImage(iname)
    for name, info in pairs(itemdatabase) do
        if iname:lower() == name:lower() then
            return info.Image
        end
    end
    return "rbxassetid://0" -- Default image if not found
end

-- Enhanced Unbox Animation Function
function playUnboxAnimation(itemName)
    -- Create container in PlayerGui
    local playerGui = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    
    -- Create main container
    local container = Instance.new("ScreenGui")
    container.Name = "UnboxAnimation"
    container.ResetOnSpawn = false
    container.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    container.Parent = playerGui

    -- Create dark background
    local background = Instance.new("Frame")
    background.Name = "Background"
    background.Size = UDim2.new(1, 0, 1, 0)
    background.BackgroundColor3 = Color3.new(0, 0, 0)
    background.BackgroundTransparency = 1
    background.ZIndex = 1
    background.Parent = container

    -- Create box image
    local box = Instance.new("ImageLabel")
    box.Name = "Box"
    box.Size = UDim2.new(0.4, 0, 0.4, 0)
    box.Position = UDim2.new(0.3, 0, 0.3, 0)
    box.AnchorPoint = Vector2.new(0.5, 0.5)
    box.BackgroundTransparency = 1
    box.Image = "rbxassetid://14255343935" -- Mystery box image
    box.ZIndex = 2
    box.Parent = container

    -- Create glow effect
    local glow = Instance.new("ImageLabel")
    glow.Name = "Glow"
    glow.Size = UDim2.new(1.5, 0, 1.5, 0)
    glow.Position = UDim2.new(-0.25, 0, -0.25, 0)
    glow.AnchorPoint = Vector2.new(0.5, 0.5)
    glow.BackgroundTransparency = 1
    glow.Image = "rbxassetid://14255343935" -- Glow image
    glow.ImageTransparency = 1
    glow.ZIndex = 1
    glow.Parent = box

    -- Create item reveal
    local item = Instance.new("ImageLabel")
    item.Name = "Item"
    item.Size = UDim2.new(0.8, 0, 0.8, 0)
    item.Position = UDim2.new(0.5, 0, 0.5, 0)
    item.AnchorPoint = Vector2.new(0.5, 0.5)
    item.BackgroundTransparency = 1
    item.Image = getImage(itemName)
    item.ImageTransparency = 1
    item.ZIndex = 3
    item.Parent = container

    -- Create item name label
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Text = itemName:upper()
    nameLabel.Size = UDim2.new(0.6, 0, 0.1, 0)
    nameLabel.Position = UDim2.new(0.5, 0, 0.7, 0)
    nameLabel.AnchorPoint = Vector2.new(0.5, 0.5)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(255, 215, 0) -- Gold color
    nameLabel.Font = Enum.Font.GothamBlack
    nameLabel.TextSize = 24
    nameLabel.TextTransparency = 1
    nameLabel.ZIndex = 4
    nameLabel.TextStrokeTransparency = 0.7
    nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    nameLabel.Parent = container

    -- Animation sequence
    coroutine.wrap(function()
        -- Fade in background
        TweenService:Create(background, TweenInfo.new(0.3), {BackgroundTransparency = 0.7}):Play()
        
        -- Box shake animation
        for i = 1, 5 do
            local shake1 = TweenService:Create(box, TweenInfo.new(0.05), {
                Position = UDim2.new(0.32, 0, 0.28, 0)
            })
            local shake2 = TweenService:Create(box, TweenInfo.new(0.05), {
                Position = UDim2.new(0.28, 0, 0.32, 0)
            })
            local shake3 = TweenService:Create(box, TweenInfo.new(0.05), {
                Position = UDim2.new(0.3, 0, 0.3, 0)
            })
            
            shake1:Play()
            wait(0.05)
            shake2:Play()
            wait(0.05)
            shake3:Play()
            wait(0.05)
        end

        -- Box opens (scale down)
        local boxOpen = TweenService:Create(box, TweenInfo.new(0.3), {Size = UDim2.new(0, 0, 0, 0)})
        boxOpen:Play()

        -- Item reveal with glow
        local itemReveal = TweenService:Create(item, TweenInfo.new(0.5), {ImageTransparency = 0})
        local glowReveal = TweenService:Create(glow, TweenInfo.new(0.5), {ImageTransparency = 0.7})
        local nameReveal = TweenService:Create(nameLabel, TweenInfo.new(0.5), {TextTransparency = 0})
        
        itemReveal:Play()
        glowReveal:Play()
        nameReveal:Play()

        -- Pulsing glow effect
        for i = 1, 3 do
            local pulse1 = TweenService:Create(glow, TweenInfo.new(0.5), {
                Size = UDim2.new(1.8, 0, 1.8, 0), 
                ImageTransparency = 0.5
            })
            local pulse2 = TweenService:Create(glow, TweenInfo.new(0.5), {
                Size = UDim2.new(1.5, 0, 1.5, 0), 
                ImageTransparency = 0.7
            })
            
            pulse1:Play()
            wait(0.5)
            pulse2:Play()
            wait(0.5)
        end

        wait(1.5) -- Show item for a moment
        
        -- Fade out everything
        local fadeOut = TweenService:Create(container, TweenInfo.new(1), {BackgroundTransparency = 1})
        local bgFadeOut = TweenService:Create(background, TweenInfo.new(1), {BackgroundTransparency = 1})
        local itemFadeOut = TweenService:Create(item, TweenInfo.new(1), {ImageTransparency = 1})
        local nameFadeOut = TweenService:Create(nameLabel, TweenInfo.new(1), {TextTransparency = 1})
        
        fadeOut:Play()
        bgFadeOut:Play()
        itemFadeOut:Play()
        nameFadeOut:Play()
        
        wait(1) -- Wait for fade out to complete
        container:Destroy()
    end)()
end
