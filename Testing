local player = game.Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local boxmodule = require(game:GetService("ReplicatedStorage").Modules.BoxModule)
local itemdatabase = require(game:GetService("ReplicatedStorage").Database.Sync.Item)
local PlayerData = require(game:GetService("ReplicatedStorage").Modules.ProfileData)
local hi = getsenv(game:GetService("Players").LocalPlayer.PlayerGui.MainGUI.Inventory.NewItem)._G

local PlayerWeapons = PlayerData.Weapons
getgenv().newValue = ""

-- GUI Setup (Basic Input + Spawn Button)
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "UnifiedItemSpawner"

local inputBox = Instance.new("TextBox", screenGui)
inputBox.Size = UDim2.new(0, 200, 0, 30)
inputBox.Position = UDim2.new(0.5, -100, 0.5, -40)
inputBox.PlaceholderText = "Item Name"
inputBox.Text = ""
inputBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
inputBox.TextColor3 = Color3.fromRGB(255, 255, 255)

local spawnButton = Instance.new("TextButton", screenGui)
spawnButton.Size = UDim2.new(0, 200, 0, 30)
spawnButton.Position = UDim2.new(0.5, -100, 0.5, 0)
spawnButton.Text = "Spawn & Animate"
spawnButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
spawnButton.TextColor3 = Color3.new(1, 1, 1)

-- Helpers
function getrawnamebyrealname(realname)
    for i, _ in pairs(itemdatabase) do
        if realname:lower() == i:lower() then
            return i
        end
    end
    return nil
end

function getImage(iname)
    for name, info in pairs(itemdatabase) do
        if iname:lower() == name:lower() then
            return info.Image
        end
    end
end

function fakeItemDisplay(itemName)
    local jj = Instance.new("Frame")
    jj.Name = "NewItem"
    local gui = player.PlayerGui.MainGUI
    if gui:FindFirstChild("Game") and gui.Game:FindFirstChild("Inventory") then
        jj.Parent = gui.Game.Inventory.Main.Weapons.Items.Container.Classic.Container
    elseif gui:FindFirstChild("Lobby") and gui.Lobby.Screens:FindFirstChild("Inventory") then
        jj.Parent = gui.Lobby.Screens.Inventory.Main.Weapons.Items.Container.Classic.Container
    end
    jj.Size = UDim2.new(0.2, 0, 0.25, 0)
    jj.BackgroundTransparency = 1

    local kk = Instance.new("Frame", jj)
    kk.Name = "Container"
    kk.Position = UDim2.new(0, 3, 0, 3)
    kk.Size = UDim2.new(1, -6, 0.825, -6)
    kk.BackgroundColor3 = Color3.fromRGB(57, 57, 57)

    local ll = Instance.new("ImageLabel", kk)
    ll.Name = "Icon"
    ll.Size = UDim2.new(1, 0, 1, 0)
    ll.Position = UDim2.new(0.5, 0, 0.5, 0)
    ll.AnchorPoint = Vector2.new(0.5, 0.5)
    ll.Image = getImage(itemName)
    ll.BackgroundTransparency = 1

    local gg = Instance.new("Frame", jj)
    gg.Name = "ItemName"
    gg.Position = UDim2.new(0, 3, 0.8, 3)
    gg.Size = UDim2.new(1, -6, 0.2, -4)
    gg.BorderSizePixel = 2

    if itemdatabase[itemName] and itemdatabase[itemName].Rarity then
        local rarity = itemdatabase[itemName].Rarity
        if rarity == "Godly" then
            gg.BackgroundColor3 = Color3.fromRGB(255, 0, 179)
        elseif rarity == "Ancient" then
            gg.BackgroundColor3 = Color3.fromRGB(100, 10, 255)
        end
    end

    local lb = Instance.new("TextLabel", gg)
    lb.Name = "Label"
    lb.Position = UDim2.new(0.5, 0, 0.5, 0)
    lb.AnchorPoint = Vector2.new(0.5, 0.5)
    lb.Size = UDim2.new(0.9, 0, 0.9, 0)
    lb.BackgroundTransparency = 1
    lb.TextColor3 = Color3.new(1, 1, 1)
    lb.Font = Enum.Font.SourceSansBold
    lb.Text = itemName
    lb.TextScaled = true
end

function spawnAndEquipItem(name)
    if not PlayerWeapons.Owned[name] then
        PlayerWeapons.Owned[name] = 1
    else
        PlayerWeapons.Owned[name] += 1
    end

    if string.find(name, "Gun") then
        PlayerWeapons.Equipped.Gun = name
    elseif string.find(name, "Axe") or string.find(name, "Knife") or string.find(name, "Blade") then
        PlayerWeapons.Equipped.Melee = name
    end

    game:GetService("RunService"):BindToRenderStep("InventoryUpdate", 0, function()
        PlayerData.Weapons = PlayerWeapons
    end)

    game.Players.LocalPlayer.Character:BreakJoints()
end

-- Final Button Callback
spawnButton.MouseButton1Click:Connect(function()
    local input = inputBox.Text
    if input == "" then return end

    local itemName = getrawnamebyrealname(input)
    if not itemName then return end

    getgenv().newValue = itemName

    -- Actual logic
    boxmodule.OpenBox("RandomBox", itemName)
    hi.NewItem(itemName, nil, nil, 'Weapons', 1)

    -- Animation
    fakeItemDisplay(itemName)

    -- Actual spawn
    spawnAndEquipItem(itemName)

    inputBox.Text = ""
end)
